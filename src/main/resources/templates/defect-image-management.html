<!doctype html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      class="bg-[#f5f7fa]">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link th:href="@{/output.css}" rel="stylesheet">
</head>
<body class="p-5 font-pretendard">
<div class="max-w-[1200px] mx-auto bg-white p-[30px] rounded-[8px] shadow-[0_2px_4px_rgba(0,0,0,0.1)]">
    <header class="flex justify-start items-center gap-[10px] text-[#333] mb-[30px] pb-[15px] border-b-[3px]
                    border-b-[#f44336] font-bold text-[2rem]">
        <a th:href="@{/admin}"> <img th:src="@{/images/arrow-back.svg}" alt="arrow-back"> </a>
        <h1>ë¶ˆëŸ‰ ì´ë¯¸ì§€ ë“±ë¡</h1>
    </header>
    <div class="bg-[#f9f9f9] p-[25px] rounded-[6px] mb-[30px]">
        <h2 class="text-[#555] mb-5 text-[1.3rem] font-bold">ë§¤ë‰´ì–¼ íŒŒì¼ ì—…ë¡œë“œ</h2>
        <form th:action="@{/admin/defect-image-management/image}"
              method="post"
              th:object="${defectImageUploadForm}"
              enctype="multipart/form-data">
            <div class="mb-[15px]">
                <label for="productId"
                       class="block mb-[5px] text-[#555] font-medium">
                    ì œí’ˆ ì„ íƒ *
                </label>
                <select required
                        id="uploadProductSelect"
                        th:field="*{productId}"
                        class="w-full p-[10px] border border-[#ddd] rounded-[4px] text-[14px] bg-white">
                    <option value="">-- ì œí’ˆì„ ì„ íƒí•˜ì„¸ìš” --</option>
                    <option th:each="product : *{products}"
                            th:value="${product.id}"
                            th:text="${product.name}">
                    </option>
                </select>
            </div>
            <div class="mb-[15px]">
                <label for="productId"
                       class="block mb-[5px] text-[#555] font-medium">
                    ë¶ˆëŸ‰ ìœ í˜• ì„ íƒ *
                </label>
                <select required
                        id="uploadDefectTypeSelect"
                        th:field="*{defectTypeId}"
                        class="w-full p-[10px] border border-[#ddd] rounded-[4px] text-[14px] bg-white">
                    <option value="">-- ì œí’ˆì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš” --</option>
                </select>
            </div>
            <div class="mb-[15px]">
                <label for="uploadArea"
                       class="block mb-[5px] text-[#555] font-medium">
                    íŒŒì¼ ì„ íƒ (jpg, png)
                </label>
                <div id="uploadArea"
                     onclick="document.getElementById('files').click()"
                     class="border-2 border-dashed border-[#ddd] rounded-[6px] p-[30px] text-center bg-[#fafafa] cursor-pointer transition-all duration-300 hover:border-[#2196F3] hover:bg-[#f5f5f5]">
                    <p>ğŸ“„ í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸ ì•¤ ë“œë¡­</p>
                    <p class="text-[0.9rem] text-[#999] mt-[5px]">ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥</p>
                    <input type="file" id="files" name="files" accept=".jpg, .png" class="hidden" required multiple>
                    <p id="fileName" class="mt-[10px] text-[#666]"></p>
                </div>
                <div id="fileListArea"
                     class="mt-[15px] max-h-[200px] overflow-y-auto bg-white p-[10px] rounded-[4px] border border-[#ddd]">
                </div>
            </div>
            <button type="submit"
                    class="bg-[#f44336] text-white px-5 py-[10px] rounded-[4px] text-[14px] font-medium transition-all duration-300 mt-[15px] cursor-pointer">
                ì—…ë¡œë“œ
            </button>
        </form>
        <div class="text-[#666] text-[0.9rem] mt-[10px]">
            â€» ì´ë¯¸ì§€ëŠ” Object Storageì— ì €ì¥ë©ë‹ˆë‹¤.
            <br>
            â€» ì—…ë¡œë“œ ì™„ë£Œ í›„ ì„œë²„ ë°°í¬ë¥¼ ìˆ˜í–‰í•´ì•¼ ì¸ë±ì‹±ë©ë‹ˆë‹¤.
        </div>
    </div>
    <div class="mt-[30px]">
        <h2 class="text-[1.5rem] font-bold">ë“±ë¡ëœ ë¶ˆëŸ‰ ì´ë¯¸ì§€</h2>
        <div class="bg-[#ffebee] p-[15px] rounded-[6px] mb-[20px] flex justify-around text-center">
            <div class="flex-1">
                <div class="text-[24px] font-bold text-[#f44336]" th:text="${defectImagePage.totalElements}">
                    111
                </div>
                <div class="text-[14px] text-[#666] mt-[5px]">
                    ì´ ì´ë¯¸ì§€ ìˆ˜
                </div>
            </div>
        </div>
        <div class="mt-[30px]">
            <div class="mb-5 p-[15px] bg-[#f9f9f9] rounded-[6px]">
                <form th:action="@{/admin/defect-image-management}" method="get" th:object="${defectImageInquiryForm}">
                    <label for="productId"
                           class="mr-[10px] font-medium">
                        ì œí’ˆ í•„í„°:
                    </label>
                    <select id="inquiryProductSelect"
                            th:field="*{productId}"
                            class="p-2 border border-[#ddd] rounded-[4px] bg-white text-[13px]"
                            onchange="this.form.submit()">
                        <option value="">ì „ì²´ ì œí’ˆ</option>
                        <option th:each="product : *{products}"
                                th:value="${product.id}"
                                th:text="${product.name}">
                        </option>
                    </select>
                    <lasubel for="defectType"
                           class="mr-[10px] font-medium">
                        ë¶ˆëŸ‰ ìœ í˜•:
                    </lasubel>
                    <select id="inquiryDefectTypeSelect"
                            th:field="*{defectTypeId}"
                            class="p-2 border border-[#ddd] rounded-[4px] bg-white text-[13px]"
                            onchange="this.form.submit()">
                        <option value="">ì „ì²´ ë¶ˆëŸ‰</option>
                        <option th:each="defectType : *{defectTypes}"
                                th:value="${defectType.id}"
                                th:text="${defectType.nameKo}">
                        </option>
                    </select>
                </form>
            </div>
        </div>
        <div class="grid grid-cols-[repeat(auto-fill,_minmax(200px,_1fr))] gap-[15px] mt-5">
            <div th:each="image : ${defectImages}"
                 class="border border-[#ddd] rounded-[6px] overflow-hidden bg-white
                        transition-transform duration-200 transition-shadow
                        hover:-translate-y-1.5 hover:shadow-[0_4px_8px_rgba(0,0,0,0.15)]">
                <img th:src="'https://kr.object.ncloudstorage.com/dm-obs' + ${image.path}" alt="defect-image"
                     class="w-full h-[200px] object-cover bg-[#f5f5f5]">

                <div class="p-[10px]">
                    <div class="text-[12px] text-[#666] mb-2 break-all" th:text="${image.name}">filename</div>
                    <div class="flex gap-[5px]">
                        <form th:action="@{/admin/defect-image-management/image}" th:method="delete">
                            <input type="hidden" name="id" th:value="${image.id}"/>
                            <button type="submit"
                                    class="bg-[#f44336] text-white text-[12px] px-[10px] py-[5px] rounded-[4px] cursor-pointer font-medium transition-all duration-300 hover:bg-[#da190b]"
                                    th:onclick="'deleteImage(' + ${image.id} + ')'">
                                ì‚­ì œ
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div th:replace="~{_fragments/pagination :: controls(page=${defectImagePage},pageParam=${'page'})}"></div>
    </div>
</div>

<script>
    // ì—¬ëŸ¬ íŒŒì¼ì„ ì €ì¥ ë° ì¡°ì‘í•  JS ë°°ì—´
    let uploadedFiles = [];

    // íŒŒì¼ input change ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    document.getElementById('files').addEventListener('change', function (e) {
        // ê¸°ì¡´ íŒŒì¼ + ìƒˆë¡­ê²Œ ì¶”ê°€ëœ íŒŒì¼ ë³‘í•©(ì¤‘ë³µ í—ˆìš© ì‹œ ì¤‘ë³µ ì œê±° ë¡œì§ í•„ìš”)
        uploadedFiles = Array.from(e.target.files);
        renderFileList();
    });

    function renderFileList() {
        const area = document.getElementById('fileListArea');
        if (uploadedFiles.length === 0) {
            area.style.display = 'none';
            area.innerHTML = ""; // í˜¹ì‹œ ëª¨ë¥¼ ì´ì „ ë‚´ìš© ì´ˆê¸°í™”
        } else {
            area.style.display = 'block';
            area.innerHTML = "";
            uploadedFiles.forEach((file, i) => {
                const div = document.createElement('div');
                div.className = "p-2 mb-[5px] bg-[#f5f5f5] rounded-[4px] flex justify-between items-center";
                div.innerHTML =
                    `<span>${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
         <button type="button"
            onclick="removeFile(${i})"
            class="px-2 py-[3px] bg-[#f44336] text-white border-none rounded-[3px] cursor-pointer text-[12px]">
           ì‚­ì œ
         </button>`;
                area.appendChild(div);
            });
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('fileListArea').style.display = 'none';
    });

    // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
    function removeFile(idx) {
        uploadedFiles.splice(idx, 1);
        renderFileList();

        // íŒŒì¼ì´ ì—†ìœ¼ë©´ input ì¬ì„¤ì •(required ë“±)
        if (uploadedFiles.length === 0) {
            document.getElementById('files').value = '';
        }
    }

    // í¼ submit ì „ì— FormDataì— uploadedFiles ë‚´ìš©ì„ append
    document.querySelector('form').addEventListener('submit', function (e) {
        if (uploadedFiles.length === 0) {
            alert('íŒŒì¼ì„ 1ê°œ ì´ìƒ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.');
            e.preventDefault();
            return;
        }
        const dt = new DataTransfer();
        uploadedFiles.forEach(f => dt.items.add(f));
        document.getElementById('files').files = dt.files; // ì‹¤ì œ inputì— íŒŒì¼ í• ë‹¹
    });

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì˜µì…˜ ì¶”ê°€ (í•„ìš” ì‹œ)
    document.getElementById('uploadArea').addEventListener('dragover', function (e) {
        e.preventDefault();
        this.classList.add('border-[#2196F3]');
    });
    document.getElementById('uploadArea').addEventListener('drop', function (e) {
        e.preventDefault();
        this.classList.remove('border-[#2196F3]');
        const droppedFiles = Array.from(e.dataTransfer.files).filter(f => (
            f.type === "image/png" || f.type === "image/jpeg"
        ));
        uploadedFiles = uploadedFiles.concat(droppedFiles);
        renderFileList();
    });

    document.getElementById('uploadProductSelect').addEventListener('change', function () {
        const productId = this.value;
        fetch('/api/v1/defect-types?productId=' + productId)
            .then(res => res.json())
            .then(data => {
                const dfSelect = document.getElementById('uploadDefectTypeSelect');
                dfSelect.innerHTML = '<option value="">ë¶ˆëŸ‰ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                data.forEach(type => {
                    const opt = document.createElement('option');
                    opt.value = type.id;
                    opt.text = type.nameKo;
                    dfSelect.appendChild(opt);
                });
                dfSelect.disabled = false;
            });
    });
</script>
</body>
</html>